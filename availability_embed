<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sports Field Status</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-100 font-sans text-gray-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useMemo } = React;
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyA-AwiFvSq3_AuDVZE5l1Pn4oAIfZTFmOM",
            authDomain: "opsf---comms-task-tracker.firebaseapp.com",
            projectId: "opsf---comms-task-tracker",
            storageBucket: "opsf---comms-task-tracker.firebasestorage.app",
            messagingSenderId: "489224390639",
            appId: "1:489224390639:web:c5da72d0dc302d8332581a",
            measurementId: "G-CBJK0070Z1"
        };

        const getFieldsCol = (db) => collection(db, "sports_fields_status");
        const getStatusDoc = (db) => doc(db, "sports_fields_status_config", "statuses");

        const LoadingSpinner = () => (
            <div className="flex items-center justify-center p-10">
                <svg className="animate-spin -ml-1 mr-3 h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
        );

        const DisplayPage = ({ db }) => {
            const [fields, setFields] = useState([]);
            const [statuses, setStatuses] = useState({});
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            
            // Search State
            const [searchQuery, setSearchQuery] = useState("");
            const [locationFilter, setLocationFilter] = useState("all");
            const [statusFilter, setStatusFilter] = useState("all");

            useEffect(() => {
                if (!db) return;
                setLoading(true);
                const subs = [];
                try {
                    subs.push(onSnapshot(getStatusDoc(db), (docSnap) => {
                        const statusOptions = docSnap.data()?.options || [];
                        const statusMap = statusOptions.reduce((acc, status) => { acc[status.id] = status; return acc; }, {});
                        setStatuses(statusMap);
                    }));
                    subs.push(onSnapshot(query(getFieldsCol(db)), (snapshot) => {
                        const fieldList = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.name.localeCompare(b.name));
                        setFields(fieldList);
                        setLoading(false);
                    }));
                } catch (err) { setError("Could not load data."); setLoading(false); }
                return () => subs.forEach(unsub => unsub());
            }, [db]);

            // Compute unique locations for the dropdown
            const uniqueLocations = useMemo(() => {
                const locs = new Set(fields.map(f => f.location).filter(Boolean));
                return Array.from(locs).sort();
            }, [fields]);

            // Filter logic
            const filteredFields = fields.filter(field => {
                const matchesSearch = (field.name || "").toLowerCase().includes(searchQuery.toLowerCase()) || 
                                      (field.location || "").toLowerCase().includes(searchQuery.toLowerCase());
                const matchesLocation = locationFilter === "all" || field.location === locationFilter;
                const matchesStatus = statusFilter === "all" || field.currentStatusId === statusFilter;

                return matchesSearch && matchesLocation && matchesStatus;
            });

            if (loading) return <LoadingSpinner />;
            if (error) return <div className="p-4 text-center text-red-600">{error}</div>;

            const getStatusColor = (status) => {
                const color = status?.color || "#808080";
                const hex = color.replace("#", "");
                const r = parseInt(hex.substring(0, 2), 16);
                const g = parseInt(hex.substring(2, 4), 16);
                const b = parseInt(hex.substring(4, 6), 16);
                const textColor = ((r * 299 + g * 587 + b * 114) / 1000) > 150 ? "text-black" : "text-white";
                return { backgroundColor: color, textColor };
            };

            const lastUpdated = new Date().toLocaleString('en-AU', { dateStyle: 'medium', timeStyle: 'short', hour12: true });

            return (
                <div className="mx-auto max-w-4xl p-4 sm:p-6">
                    <h1 className="mb-6 text-center text-3xl font-bold text-gray-800">Sports Field Status</h1>
                    
                    {/* Advanced Search & Filter Bar */}
                    <div className="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-6 space-y-3 sm:space-y-0 sm:flex sm:gap-3">
                        {/* 1. Text Search */}
                        <div className="relative flex-grow">
                            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg className="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fillRule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clipRule="evenodd" />
                                </svg>
                            </div>
                            <input
                                type="text"
                                placeholder="Search name or suburb..."
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                                className="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                            />
                        </div>

                        {/* 2. Location Dropdown (Only shows if locations exist) */}
                        {uniqueLocations.length > 0 && (
                            <div className="sm:w-48 flex-shrink-0">
                                <select 
                                    value={locationFilter}
                                    onChange={(e) => setLocationFilter(e.target.value)}
                                    className="block w-full py-2 pl-3 pr-10 border border-gray-300 bg-white rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                >
                                    <option value="all">All Locations</option>
                                    {uniqueLocations.map(loc => (
                                        <option key={loc} value={loc}>{loc}</option>
                                    ))}
                                </select>
                            </div>
                        )}

                        {/* 3. Status Dropdown */}
                        <div className="sm:w-48 flex-shrink-0">
                             <select 
                                value={statusFilter}
                                onChange={(e) => setStatusFilter(e.target.value)}
                                className="block w-full py-2 pl-3 pr-10 border border-gray-300 bg-white rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                            >
                                <option value="all">All Statuses</option>
                                {Object.values(statuses).map(s => (
                                    <option key={s.id} value={s.id}>{s.text}</option>
                                ))}
                            </select>
                        </div>
                    </div>

                    {/* Results List */}
                    {filteredFields.length === 0 ? (
                        <div className="text-center py-12 bg-white rounded-lg border border-dashed border-gray-300">
                            <svg className="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <h3 className="mt-2 text-sm font-medium text-gray-900">No fields found</h3>
                            <p className="mt-1 text-sm text-gray-500">Try adjusting your search or filters.</p>
                            <button onClick={() => {setSearchQuery(""); setLocationFilter("all"); setStatusFilter("all");}} className="mt-3 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200">
                                Clear Filters
                            </button>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            {filteredFields.map((field) => {
                                const status = statuses[field.currentStatusId] || { text: "Unknown", color: "#808080" };
                                const { backgroundColor, textColor } = getStatusColor(status);
                                const isLink = !!status.infoLink;
                                const BadgeComponent = isLink ? 'a' : 'span';
                                const badgeProps = isLink ? { href: status.infoLink, target: "_blank", rel: "noopener noreferrer", title: "Click to view policy/info" } : {};

                                return (
                                    <div key={field.id} className="flex flex-col rounded-lg bg-white p-5 shadow-md transition-shadow hover:shadow-lg sm:flex-row sm:items-start sm:justify-between">
                                        <div className="flex flex-col flex-grow pr-4">
                                            <div className="flex items-start justify-between">
                                                <h2 className="mb-1 text-xl font-semibold text-gray-900">{field.name}</h2>
                                            </div>
                                            {field.location && (
                                                <p className="text-sm text-gray-500 mb-2 flex items-center">
                                                    <svg className="w-4 h-4 mr-1 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                                    </svg>
                                                    {field.location}
                                                </p>
                                            )}
                                            
                                            {(field.webLink || field.mapLink) && (
                                                <div className="flex flex-wrap gap-3 mt-1">
                                                    {field.webLink && <a href={field.webLink} target="_blank" rel="noopener noreferrer" className="flex items-center text-sm text-blue-600 hover:text-blue-800 hover:underline"><svg className="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>More Info</a>}
                                                    {field.mapLink && <a href={field.mapLink} target="_blank" rel="noopener noreferrer" className="flex items-center text-sm text-blue-600 hover:text-blue-800 hover:underline"><svg className="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>Directions</a>}
                                                </div>
                                            )}
                                        </div>
                                        <div className="mt-4 sm:mt-0 flex-shrink-0">
                                            <BadgeComponent {...badgeProps} className={`inline-flex items-center justify-center rounded-full px-4 py-2 text-sm font-bold ${textColor} text-center w-full sm:w-auto transition-transform ${isLink ? 'hover:scale-105 hover:underline cursor-pointer' : ''}`} style={{ backgroundColor }}>
                                            {status.text}
                                            {isLink && <svg className="w-4 h-4 ml-2 opacity-80" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>}
                                            </BadgeComponent>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                    <p className="mt-8 text-center text-sm text-gray-400">Last updated: {lastUpdated}</p>
                </div>
            );
        };

        const App = () => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [error, setError] = useState(null);

            useEffect(() => {
                try {
                    const app = initializeApp(firebaseConfig);
                    const firestoreDb = getFirestore(app);
                    const firebaseAuth = getAuth(app);
                    
                    setDb(firestoreDb);
                    setAuth(firebaseAuth);
                    
                    const unsub = onAuthStateChanged(firebaseAuth, async (user) => {
                        if (user) {
                             setIsAuthReady(true);
                        } else {
                            try {
                                await signInAnonymously(firebaseAuth);
                            } catch (err) {
                                console.error("Anonymous auth failed:", err);
                                setError("Authentication Failed: Please ensure Anonymous Authentication is enabled in the Firebase Console.");
                            }
                        }
                    });
                    return () => unsub();
                } catch (err) { 
                    console.error("Init failed:", err);
                    setError("Configuration Error: " + err.message); 
                }
            }, []);

            if (error) return <div className="p-10 text-center text-red-600 bg-red-50 m-4 rounded-lg border border-red-200">
                <h3 className="font-bold text-lg mb-2">Setup Required</h3>
                <p>{error}</p>
            </div>;
            
            if (!isAuthReady) return <LoadingSpinner />;
            return (
                <div className="min-h-screen bg-gray-100 font-sans">
                    <main><DisplayPage db={db} /></main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
