<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Field Status Admin - Clarence Valley Council</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-100 font-sans text-gray-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useMemo } = React;
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        // Reverted to Anonymous Auth as requested
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, runTransaction, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- PASSWORD CONFIGURATION ---
        // CHANGE THIS PASSWORD BELOW
        const ADMIN_PASSWORD = "admin123"; 

        const firebaseConfig = {
            apiKey: "AIzaSyA-AwiFvSq3_AuDVZE5l1Pn4oAIfZTFmOM",
            authDomain: "opsf---comms-task-tracker.firebaseapp.com",
            projectId: "opsf---comms-task-tracker",
            storageBucket: "opsf---comms-task-tracker.firebasestorage.app",
            messagingSenderId: "489224390639",
            appId: "1:489224390639:web:c5da72d0dc302d8332581a",
            measurementId: "G-CBJK0070Z1"
        };

        const getFieldsCol = (db) => collection(db, "sports_fields_status");
        const getStatusDoc = (db) => doc(db, "sports_fields_status_config", "statuses");

        const LoadingSpinner = () => (
            <div className="flex items-center justify-center p-10">
                <svg className="animate-spin -ml-1 mr-3 h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <span className="text-lg text-gray-700">Loading...</span>
            </div>
        );

        // Simple Password Overlay Component
        const PasswordScreen = ({ onUnlock }) => {
            const [input, setInput] = useState("");
            const [error, setError] = useState(false);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (input === ADMIN_PASSWORD) {
                    onUnlock();
                } else {
                    setError(true);
                    setInput("");
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50 px-4">
                    <div className="max-w-md w-full bg-white rounded-lg shadow-md p-8">
                        <h2 className="text-2xl font-bold text-center text-blue-900 mb-2">Restricted Access</h2>
                        <p className="text-center text-gray-600 mb-6">Enter password to manage field status.</p>
                        
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <input 
                                    type="password" 
                                    value={input}
                                    onChange={(e) => { setInput(e.target.value); setError(false); }}
                                    placeholder="Enter Password"
                                    className={`w-full p-3 border rounded-md focus:ring-2 focus:outline-none ${error ? 'border-red-500 focus:ring-red-200' : 'border-gray-300 focus:ring-blue-200'}`}
                                    autoFocus
                                />
                                {error && <p className="text-red-600 text-sm mt-2">Incorrect password.</p>}
                            </div>
                            <button type="submit" className="w-full bg-blue-600 text-white font-bold py-3 rounded-md hover:bg-blue-700 transition duration-200">
                                Enter
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" onClick={onClose}>
                    <div className="relative w-full max-w-lg rounded-lg bg-white p-6 shadow-xl overflow-y-auto max-h-[90vh]" onClick={(e) => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute -top-2 -right-2 flex h-8 w-8 items-center justify-center rounded-full bg-gray-600 text-white transition hover:bg-gray-800">&times;</button>
                        <h3 className="mb-4 text-xl font-semibold text-gray-900">{title}</h3>
                        <div>{children}</div>
                    </div>
                </div>
            );
        };

        const AdminPage = ({ db }) => {
            const [activeTab, setActiveTab] = useState('editor');
            const [fields, setFields] = useState([]);
            const [statuses, setStatuses] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [selectedFields, setSelectedFields] = useState(new Set());

            // Modals state
            const [isFieldModalOpen, setIsFieldModalOpen] = useState(false);
            const [isStatusModalOpen, setIsStatusModalOpen] = useState(false);
            const [editingField, setEditingField] = useState(null);
            const [editingStatus, setEditingStatus] = useState(null);

            useEffect(() => {
                if (!db) return;
                setLoading(true);
                const subs = [];
                try {
                    subs.push(onSnapshot(getStatusDoc(db), (docSnap) => setStatuses(docSnap.data()?.options || []), err => { console.error(err); setError("Could not load statuses."); }));
                    subs.push(onSnapshot(query(getFieldsCol(db)), (snapshot) => {
                        setFields(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.name.localeCompare(b.name)));
                        setLoading(false);
                    }, err => { console.error(err); setError("Could not load fields."); }));
                } catch (err) { console.error(err); setLoading(false); }
                return () => subs.forEach(u => u());
            }, [db]);

            const getContrastColor = (hex) => {
                if (!hex) return 'black';
                const r = parseInt(hex.substring(1, 3), 16), g = parseInt(hex.substring(3, 5), 16), b = parseInt(hex.substring(5, 7), 16);
                return ((r * 299 + g * 587 + b * 114) / 1000) > 128 ? 'black' : 'white';
            };

            const handleSetFieldStatus = async (fieldId, statusId) => { try { await updateDoc(doc(getFieldsCol(db), fieldId), { currentStatusId: statusId }); } catch (err) { console.error(err); } };
            const handleBulkStatusUpdate = async (statusId) => {
                const batch = writeBatch(db);
                selectedFields.forEach(fieldId => { const ref = doc(getFieldsCol(db), fieldId); batch.update(ref, { currentStatusId: statusId }); });
                try { await batch.commit(); setSelectedFields(new Set()); } catch (err) { console.error("Bulk update failed:", err); }
            };
            const handleSaveField = async (name, location, webLink, mapLink) => {
                if (!name.trim()) return;
                const data = { name: name.trim(), location: location.trim(), webLink: webLink.trim(), mapLink: mapLink.trim() };
                try { if (editingField?.id) await updateDoc(doc(getFieldsCol(db), editingField.id), data); else await addDoc(getFieldsCol(db), { ...data, currentStatusId: statuses[0]?.id || null }); setIsFieldModalOpen(false); setEditingField(null); } catch (err) { console.error(err); }
            };
            const handleDeleteField = async (id) => { if (window.confirm("Delete field?")) try { await deleteDoc(doc(getFieldsCol(db), id)); } catch (err) { console.error(err); } };
            const handleSaveStatus = async (text, color, infoLink) => {
                if (!text.trim()) return;
                const data = { text: text.trim(), color: color.trim(), infoLink: infoLink?.trim() || "" };
                let newStatuses = editingStatus?.id ? statuses.map(s => s.id === editingStatus.id ? { ...s, ...data } : s) : [...statuses, { id: crypto.randomUUID(), ...data }];
                try { await setDoc(getStatusDoc(db), { options: newStatuses }); setIsStatusModalOpen(false); setEditingStatus(null); } catch (err) { console.error(err); }
            };
            const handleDeleteStatus = async (id) => {
                const newStatuses = statuses.filter(s => s.id !== id);
                try { await setDoc(getStatusDoc(db), { options: newStatuses }); const q = query(getFieldsCol(db), where("currentStatusId", "==", id)); const batch = writeBatch(db); (await getDocs(q)).forEach(d => batch.update(d.ref, { currentStatusId: newStatuses[0]?.id || null })); await batch.commit(); } catch (err) { console.error(err); }
            };
            const toggleSelect = (id) => { const newSet = new Set(selectedFields); if (newSet.has(id)) newSet.delete(id); else newSet.add(id); setSelectedFields(newSet); };
            const toggleSelectAll = () => { if (selectedFields.size === fields.length) setSelectedFields(new Set()); else setSelectedFields(new Set(fields.map(f => f.id))); };

            const renderFieldModal = () => (
                <Modal isOpen={isFieldModalOpen} onClose={() => { setIsFieldModalOpen(false); setEditingField(null); }} title={editingField ? "Edit Field" : "Add New Field"}>
                    <form onSubmit={(e) => { e.preventDefault(); handleSaveField(e.target.name.value, e.target.location.value, e.target.webLink.value, e.target.mapLink.value); }}>
                        <div className="space-y-4">
                            <div><label className="block text-sm font-medium text-gray-700">Field Name *</label><input required name="name" defaultValue={editingField?.name} className="mt-1 block w-full rounded-md border border-gray-300 p-2" /></div>
                            <div><label className="block text-sm font-medium text-gray-700">Location / Suburb</label><input name="location" defaultValue={editingField?.location} placeholder="e.g. Yamba" className="mt-1 block w-full rounded-md border border-gray-300 p-2" /></div>
                            <div><label className="block text-sm font-medium text-gray-700">Web Link</label><input type="url" name="webLink" defaultValue={editingField?.webLink} className="mt-1 block w-full rounded-md border border-gray-300 p-2" /></div>
                            <div><label className="block text-sm font-medium text-gray-700">Map Link</label><input type="url" name="mapLink" defaultValue={editingField?.mapLink} className="mt-1 block w-full rounded-md border border-gray-300 p-2" /></div>
                        </div>
                        <div className="mt-6 flex justify-end space-x-2"><button type="button" onClick={() => setIsFieldModalOpen(false)} className="px-4 py-2 border rounded hover:bg-gray-50">Cancel</button><button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save</button></div>
                    </form>
                </Modal>
            );

            const renderStatusModal = () => (
                <Modal isOpen={isStatusModalOpen} onClose={() => { setIsStatusModalOpen(false); setEditingStatus(null); }} title={editingStatus ? "Edit Status" : "Add New Status"}>
                    <form onSubmit={(e) => { e.preventDefault(); handleSaveStatus(e.target.text.value, e.target.color.value, e.target.infoLink.value); }}>
                        <div className="space-y-4">
                            <div><label className="block text-sm font-medium text-gray-700">Status Text *</label><input required name="text" defaultValue={editingStatus?.text} className="mt-1 block w-full rounded-md border border-gray-300 p-2" /></div>
                            <div><label className="block text-sm font-medium text-gray-700">Policy URL</label><input type="url" name="infoLink" defaultValue={editingStatus?.infoLink} className="mt-1 block w-full rounded-md border border-gray-300 p-2" /></div>
                            <div><label className="block text-sm font-medium text-gray-700">Color</label><input type="color" name="color" defaultValue={editingStatus?.color || "#000000"} className="mt-1 h-10 w-20 p-0 border rounded" /></div>
                        </div>
                        <div className="mt-6 flex justify-end space-x-2"><button type="button" onClick={() => setIsStatusModalOpen(false)} className="px-4 py-2 border rounded hover:bg-gray-50">Cancel</button><button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save</button></div>
                    </form>
                </Modal>
            );

            if (loading) return <LoadingSpinner />;
            if (error) return <div className="p-4 text-center text-red-600">{error}</div>;

            return (
                <div className="mx-auto max-w-5xl p-4 sm:p-6 pb-24">
                    {renderFieldModal()} {renderStatusModal()}
                    <div className="flex justify-between items-center mb-6">
                        <h1 className="text-3xl font-bold text-gray-800">Admin Control Panel</h1>
                        <button onClick={() => window.location.reload()} className="text-sm text-gray-600 hover:text-gray-900 font-medium">Log Out</button>
                    </div>
                    
                    <div className="mb-6 border-b border-gray-200">
                        <nav className="-mb-px flex flex-wrap space-x-4">
                            {['editor', 'fields', 'statuses'].map(t => (
                                <button key={t} onClick={() => setActiveTab(t)} className={`px-4 py-2 font-medium capitalize border-b-2 ${activeTab === t ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>
                                    {t === 'editor' ? 'Set Statuses' : t === 'fields' ? 'Manage Fields' : 'Manage Options'}
                                </button>
                            ))}
                        </nav>
                    </div>

                    <div className="rounded-lg bg-gray-50 p-4 shadow-inner sm:p-6">
                        {activeTab === 'editor' && (
                            <div>
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-semibold">Update Status</h2>
                                    <button onClick={toggleSelectAll} className="text-sm text-blue-600 hover:underline">
                                        {selectedFields.size === fields.length ? 'Deselect All' : 'Select All'}
                                    </button>
                                </div>
                                <div className="space-y-4">
                                    {fields.map(field => (
                                        <div key={field.id} className={`flex flex-col sm:flex-row rounded-lg border bg-white p-4 shadow-sm transition-colors ${selectedFields.has(field.id) ? 'border-blue-400 bg-blue-50' : 'border-gray-200'}`}>
                                            <div className="flex items-center mb-3 sm:mb-0 sm:mr-4">
                                                <input type="checkbox" checked={selectedFields.has(field.id)} onChange={() => toggleSelect(field.id)} className="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                                            </div>
                                            <div className="flex-grow mb-3 sm:mb-0">
                                                <span className="block text-lg font-medium text-gray-800">{field.name}</span>
                                                {field.location && <span className="text-sm text-gray-500">{field.location}</span>}
                                            </div>
                                            <div className="flex flex-wrap gap-2">
                                                {statuses.map(status => {
                                                    const active = field.currentStatusId === status.id;
                                                    return (
                                                        <button key={status.id} onClick={() => handleSetFieldStatus(field.id, status.id)} 
                                                            className={`px-3 py-1 rounded text-sm font-bold border-2 transition-all ${active ? 'scale-105 shadow-sm' : 'opacity-60 hover:opacity-100'}`}
                                                            style={{ backgroundColor: active ? status.color : 'transparent', borderColor: status.color, color: active ? getContrastColor(status.color) : status.color }}>
                                                            {status.text}
                                                        </button>
                                                    )
                                                })}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'fields' && (
                            <div>
                                <div className="flex justify-between mb-4"><h2 className="text-xl font-semibold">Manage Fields</h2><button onClick={() => { setEditingField(null); setIsFieldModalOpen(true); }} className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Add Field</button></div>
                                <div className="divide-y rounded-md border bg-white">
                                    {fields.map(f => (
                                        <div key={f.id} className="p-4 flex justify-between items-center">
                                            <div>
                                                <div className="font-medium text-gray-900">{f.name}</div>
                                                <div className="text-sm text-gray-500">{f.location || "No location set"}</div>
                                            </div>
                                            <div className="flex gap-2"><button onClick={() => { setEditingField(f); setIsFieldModalOpen(true); }} className="text-yellow-600 hover:underline">Edit</button><button onClick={() => handleDeleteField(f.id)} className="text-red-600 hover:underline">Delete</button></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        
                        {activeTab === 'statuses' && (
                            <div>
                                <div className="flex justify-between mb-4"><h2 className="text-xl font-semibold">Manage Status Options</h2><button onClick={() => { setEditingStatus(null); setIsStatusModalOpen(true); }} className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Add Status</button></div>
                                <div className="divide-y rounded-md border bg-white">
                                    {statuses.map(s => (
                                        <div key={s.id} className="p-4 flex justify-between items-center">
                                            <div className="flex items-center gap-3">
                                                <div className="w-6 h-6 rounded-full border" style={{backgroundColor: s.color}}></div>
                                                <div><div className="font-medium">{s.text}</div>{s.infoLink && <div className="text-xs text-blue-500">Link set</div>}</div>
                                            </div>
                                            <div className="flex gap-2"><button onClick={() => { setEditingStatus(s); setIsStatusModalOpen(true); }} className="text-yellow-600 hover:underline">Edit</button><button onClick={() => handleDeleteStatus(s.id)} className="text-red-600 hover:underline">Delete</button></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Bulk Action Bar */}
                    {selectedFields.size > 0 && activeTab === 'editor' && (
                        <div className="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg p-4 z-40 transform transition-transform">
                            <div className="max-w-5xl mx-auto flex flex-col sm:flex-row items-center justify-between gap-4">
                                <span className="font-semibold text-gray-700">{selectedFields.size} fields selected</span>
                                <div className="flex flex-wrap justify-center gap-2">
                                    {statuses.map(status => (
                                        <button key={status.id} onClick={() => handleBulkStatusUpdate(status.id)} 
                                            className="px-4 py-2 rounded text-white font-bold shadow hover:opacity-90"
                                            style={{ backgroundColor: status.color, color: getContrastColor(status.color) }}>
                                            Set to {status.text}
                                        </button>
                                    ))}
                                    <button onClick={() => setSelectedFields(new Set())} className="px-4 py-2 rounded bg-gray-200 text-gray-700 hover:bg-gray-300">Cancel</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const preloadDefaultData = async (db) => {
             try {
                const statusDocRef = getStatusDoc(db);
                const statusSnap = await getDoc(statusDocRef);
                if (!statusSnap.exists()) {
                    await setDoc(statusDocRef, { options: [
                        { id: 'status-open', text: 'Open', color: '#22c55e', infoLink: '' },
                        { id: 'status-closed', text: 'Closed', color: '#ef4444', infoLink: '' },
                        { id: 'status-wet-weather', text: 'CLOSED Wet Weather Sports Management Policy Applies', color: '#f97316', infoLink: '' }
                    ]});
                }
                const fieldsColRef = getFieldsCol(db);
                if ((await getDocs(query(fieldsColRef))).empty) {
                    const names = ["Barnier Park - Soccer Fields - 1", "Barnier Park - Soccer Fields - 2; 3; 4", "Brooms Head Oval, Brooms Head", "Ellem Oval, Grafton"]; 
                    const batch = writeBatch(db);
                    names.forEach(n => batch.set(doc(fieldsColRef), { name: n, location: "", currentStatusId: 'status-closed', webLink: '', mapLink: '' }));
                    await batch.commit();
                }
            } catch (err) { console.error(err); }
        };

        const App = () => {
            const [db, setDb] = useState(null);
            const [firebaseUser, setFirebaseUser] = useState(null);
            const [isPasswordCorrect, setIsPasswordCorrect] = useState(false);
            const [appReady, setAppReady] = useState(false);
            const preloadRef = React.useRef(false);

            useEffect(() => {
                const app = initializeApp(firebaseConfig);
                const _db = getFirestore(app);
                setDb(_db);
                const _auth = getAuth(app);
                
                const unsub = onAuthStateChanged(_auth, async u => {
                    if (u) {
                        setFirebaseUser(u);
                        setAppReady(true);
                        if (!preloadRef.current) { 
                            preloadRef.current = true; 
                            await preloadDefaultData(_db); 
                        }
                    } else {
                        // Automatically sign in anonymously on load
                        signInAnonymously(_auth).catch(console.error);
                    }
                });
                return () => unsub();
            }, []);

            if (!appReady) return <LoadingSpinner />;

            // 1. Password Check
            if (!isPasswordCorrect) {
                return <PasswordScreen onUnlock={() => setIsPasswordCorrect(true)} />;
            }

            // 2. Admin Panel (User is authenticated anonymously AND entered correct password)
            return <AdminPage db={db} />;
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
